TRUNCATE TABLE leave_balances RESTART IDENTITY CASCADE;
TRUNCATE TABLE leaves RESTART IDENTITY CASCADE;
TRUNCATE TABLE import_histories RESTART IDENTITY CASCADE;
TRUNCATE TABLE annual_leave_closures RESTART IDENTITY CASCADE;
TRUNCATE TABLE personnels RESTART IDENTITY CASCADE;
TRUNCATE TABLE directions RESTART IDENTITY CASCADE;
TRUNCATE TABLE services RESTART IDENTITY CASCADE;
TRUNCATE TABLE fonctions RESTART IDENTITY CASCADE;

SELECT
    direction,
    service,
    SUM(jours_utilises) AS total_jours_utilises
FROM leaves
WHERE approuve_rh = true
  AND EXTRACT(YEAR FROM date_debut) = :annee
  AND (:direction IS NULL OR direction = :direction)
  AND (:service IS NULL OR service = :service)
GROUP BY direction, service;

CREATE UNIQUE INDEX leave_unique_period
ON leaves (personnel_id, date_debut, date_fin, heure_debut, heure_fin);


UPDATE leave_balances
SET annee_reference = EXTRACT(YEAR FROM CURRENT_DATE) - 1
WHERE annee_reference IS NULL;

UPDATE leave_types
SET autorise_solde_negatif = true
WHERE code = 'ANTICIPE';


ALTER TABLE leave_balances
ADD CONSTRAINT uq_leave_balance_personnel_annee
UNIQUE (personnel_id, annee_reference);

ALTER TABLE leave_balances
ALTER COLUMN annee_reference SET NOT NULL;



ALTER TABLE leave_balances
ALTER COLUMN annee_reference SET NOT NULL;

BEGIN;

-- 1Ô∏è‚É£ Audits cong√©s
DELETE FROM leave_audits;

-- 2Ô∏è‚É£ Cl√¥tures annuelles
DELETE FROM annual_leave_closures;

-- 3Ô∏è‚É£ Soldes de cong√©s
DELETE FROM leave_balances;

-- 4Ô∏è‚É£ Cong√©s
DELETE FROM leaves;

-- 5Ô∏è‚É£ (OPTIONNEL) R√©initialisation personnels
-- ‚ö†Ô∏è D√©commente seulement si tu veux TOUT r√©importer
-- DELETE FROM personnels;

-- 6Ô∏è‚É£ (OPTIONNEL) R√©f√©rentiels si n√©cessaire
-- DELETE FROM fonctions;
-- DELETE FROM services;
-- DELETE FROM directions;

COMMIT;


BACKEND ‚Äì Controller
AdminRHController.php
<?php

namespace App\Http\Controllers;

use Illuminate\Support\Facades\DB;
use Illuminate\Http\Request;
use App\Services\LeaveAuditService;

class AdminRHController extends Controller
{
    public function resetBaseRH(Request $request)
    {
        // üîê S√©curit√© minimale
        if (!auth()->user() || !auth()->user()->is_admin) {
            abort(403, "Action non autoris√©e");
        }

        DB::transaction(function () {

            DB::table('leave_audits')->delete();
            DB::table('annual_leave_closures')->delete();
            DB::table('leave_balances')->delete();
            DB::table('leaves')->delete();
        });

        // üìú Trace RH
        app(LeaveAuditService::class)->log(
            'RESET_BASE_RH',
            null,
            null,
            [],
            [
                'message' => 'R√©initialisation compl√®te de la base RH cong√©s',
                'user'    => auth()->user()->name ?? 'ADMIN',
                'date'    => now()->toIso8601String(),
            ]
        );

        return response()->json([
            'message' => 'Base RH r√©initialis√©e avec succ√®s'
        ]);
    }
}

üõ£Ô∏è Route API
Route::post('/admin/rh/reset', [AdminRHController::class, 'resetBaseRH'])
    ->middleware(['auth:sanctum']);

üñ•Ô∏è FRONT ‚Äì Bouton React s√©curis√©
Exemple : AdminRHPanel.jsx
import React from "react";
import axios from "axios";
import { Button } from "react-bootstrap";

export default function AdminRHPanel() {

  const resetRH = () => {
    if (!window.confirm(
      "‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nCette action supprimera TOUTES les donn√©es RH de cong√©s.\n\nContinuer ?"
    )) return;

    axios.post("/api/admin/rh/reset")
      .then(() => {
        alert("‚úÖ Base RH r√©initialis√©e");
        window.location.reload();
      })
      .catch(() => {
        alert("‚ùå Erreur lors de la r√©initialisation");
      });
  };

  return (
    <div className="mt-4">
      <Button variant="danger" onClick={resetRH}>
        üßπ R√©initialiser la base RH
      </Button>
    </div>
  );
}

üìã Checklist RH AVANT NOUVEL IMPORT

‚úîÔ∏è Base RH vide
‚úîÔ∏è Aucun solde 2026
‚úîÔ∏è Aucun audit parasite
‚úîÔ∏è Aucun calcul automatique
‚úîÔ∏è Import fig√© 31/12/2025

üü¢ Prochaine √©tape (quand tu veux)

üëâ Je te propose ensuite :

üß™ sc√©nario test RH complet (import ‚Üí cl√¥ture ‚Üí 2026)

üìä √©cran de contr√¥le RH avant/apr√®s cl√¥ture

üîê verrouillage d√©finitif apr√®s cl√¥ture

Dis-moi üëâ on continu